<div class="container-fluid">
    <div class="formulario">
        <img src="gri-full-logo.png" alt="Logo GRI" class="logo-gri" />
        <br />

        <!-- Mensaje de error general -->
        @if (mensajeError) {
            <div class="alert alert-danger" role="alert">
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    {{ mensajeError }}
                </div>
            </div>
        }

        <!-- Mostrar formulario solo si el registro no fue exitoso -->
        @if (!registroExitoso) {
            <form [formGroup]="form" (ngSubmit)="onEnviar($event)">
                <div class="row justify-content-center">

                    <!-- Nombre -->
                    <div class="col-lg-6">
                        <label for="nombre" class="form-label">Nombre:</label>
                        <input type="text" formControlName="nombre" class="form-control" id="nombre" name="nombre"
                               required [disabled]="estaCargando" />
                        @if (Nombre?.errors && Nombre?.touched) { 
                            @if (Nombre?.hasError('required')) { 
                                <p class="text-danger">El nombre es requerido.</p> 
                            } 
                        }
                    </div>

                    <!-- Apellido -->
                    <div class="col-lg-6">
                        <label for="apellido" class="form-label">Apellido:</label>
                        <input type="text" formControlName="apellido" class="form-control" id="apellido" name="apellido"
                               required [disabled]="estaCargando" />
                        @if (Apellido?.errors && Apellido?.touched) { 
                            @if (Apellido?.hasError('required')) { 
                                <p class="text-danger">El apellido es requerido.</p> 
                            } 
                        }
                    </div>

                    <!-- Área -->
                    <div class="col-lg-6">
                        <label for="area" class="form-label">Área:</label>
                        <select formControlName="area" class="form-select" id="area" name="area" required [disabled]="estaCargando">
                            <option value="">Selecciona un área</option>
                            <option value="administracion">Administración</option>
                            <option value="gerencia">Gerencia</option>
                            <option value="ventas">Ventas</option>
                        </select>
                        @if (Area?.errors && Area?.touched) {
                            @if (Area?.hasError('required')) {
                                <p class="text-danger">El área es requerida.</p>
                            }
                        }
                    </div>

                    <!-- Email / Usuario -->
                    <div class="col-lg-6">
                        <label for="username" class="form-label">Usuario (Email):</label>
                        @if (chequeandoEmail) {
                            <span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>
                            <small class="text-muted">Verificando...</small>
                        }
                        <input type="email" formControlName="email" class="form-control" id="username" name="username"
                               required [disabled]="estaCargando"
                               [class.is-invalid]="Email?.errors && Email?.touched"
                               [class.is-valid]="Email?.valid && Email?.touched && !chequeandoEmail" />
                        @if (Email?.errors && Email?.touched) { 
                            @if (Email?.hasError('required')) { 
                                <p class="text-danger">El email es requerido.</p> 
                            } 
                            @else if (Email?.hasError('email')) { 
                                <p class="text-danger">El formato del email debe ser válido.</p> 
                            }
                            @else if (Email?.hasError('emailYaRegistrado')) { 
                                <p class="text-danger">Este email ya está registrado.</p> 
                            } 
                        } 
                    </div>

                    <!-- Contraseña -->
                    <div class="col-lg-6">
                        <label for="password" class="form-label">Contraseña:</label>
                        <input type="password" formControlName="password" class="form-control" id="password" name="password"
                               required [disabled]="estaCargando" />
                        @if (Password?.errors && Password?.touched) { 
                            @if (Password?.hasError('required')) { 
                                <p class="text-danger">La contraseña es requerida.</p> 
                            } 
                            @else if (Password?.hasError('minlength')) { 
                                <p class="text-danger">La contraseña debe tener al menos 7 caracteres.</p> 
                            } 
                        } 
                    </div>

                    <!-- Confirmar Contraseña -->
                    <div class="col-lg-6">
                        <label for="confirm-password" class="form-label">Confirmar Contraseña:</label>
                        <input type="password" formControlName="confirmPassword" class="form-control" id="confirm-password"
                               name="confirm-password" required (input)="confirmarPassword($event)" [disabled]="estaCargando" />
                        @if (ConfirmPassword?.errors && ConfirmPassword?.touched) { 
                            @if (ConfirmPassword?.hasError('required')) {
                                <p class="text-danger">La confirmación de contraseña es requerida.</p>
                            }
                            @if (ConfirmPassword?.hasError('noCoinciden')) {
                                <p class="text-danger">Las contraseñas no coinciden.</p>
                            }
                        }
                    </div>

                </div>
                <br />

                <!-- Botón de registro -->
                <button type="submit" class="boton-registro" style="width: 30%;" 
                        [disabled]="estaCargando || chequeandoEmail || form.invalid">
                    @if (estaCargando) {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        Registrando...
                    } @else {
                        Registrarse
                    }
                </button>
            </form>

            <!-- Link a iniciar sesión -->
            <h4 class="pt-5 pb-2">¿Ya tienes cuenta?</h4>
            <p class="pb-3">
                <a routerLink="/inicio-sesion"> Iniciar sesión aquí </a>
            </p>
        } @else {

            <!-- Mensaje de éxito -->
            <div class="text-center mt-4">
                <div class="display-1 text-success mb-3">
                    <i class="bi bi-check-circle"></i>
                </div>
                <h3 class="text-success">¡Cuenta creada exitosamente!</h3>
                <p class="text-muted">Tu cuenta ha sido creada. En unos segundos serás redirigido al inicio de sesión.</p>
                <div class="mt-3">
                    <a routerLink="/inicio-sesion" class="btn btn-outline-primary">
                        Ir a Inicio de Sesión Ahora
                    </a>
                </div>
            </div>
        }
    </div>
</div>